# 程式碼審查報告：Documents Translate Console

## 現況問題

### 1. 安全性問題

| 問題 | 位置 | 風險等級 |
|------|------|----------|
| API Key 儲存在 localStorage | 前端 | 高 |
| CORS 設定過於寬鬆 | `backend/main.py` | 中 |
| 缺少流量限制 | 多個 API 端點 | 中 |
| 檔案上傳大小未限制 | `backend/main.py` | 中 |
| SQL 注入防護不足 | `backend/services/translation_memory.py` | 低 |

### 2. 程式碼品質問題

| 問題 | 位置 | 風險等級 |
|------|------|----------|
| 前端檔案過長 | `frontend/src/App.jsx` | 高 |
| 缺少 TypeScript | 前端 | 中 |
| 缺少 ESLint 設定 | `frontend/` | 中 |
| 測試覆蓋不足 | `tests/` | 中 |
| 錯誤訊息不一致 | 多個 API 端點 | 中 |
| 硬編碼參數 | `frontend/src/App.jsx` | 低 |

### 3. 效能問題

| 問題 | 位置 | 風險等級 |
|------|------|----------|
| React 重複 render 過多 | `frontend/src/App.jsx` | 中 |
| 缺少 API 快取 | `backend/main.py` | 中 |
| 同步處理大量區塊 | `backend/main.py` | 中 |
| 資料庫索引不足 | `backend/services/translation_memory.py` | 低 |

### 4. 其他問題

| 問題 | 位置 | 風險等級 |
|------|------|----------|
| 服務層職責不清 | `backend/services/` | 中 |
| 缺少模組化分層 | 後端 | 中 |
| 設定管理分散 | 多個檔案 | 低 |
| 缺少 API 文件 | - | 低 |

---

## 改善建議

### 第一階段：安全性（優先）
1. **API Key 安全**
   - 使用後端代理 API 請求
   - 改用 HttpOnly cookies
   - 移除 localStorage 存放

2. **CORS 與流量限制**
   - 配置更嚴格的 CORS 規則
   - 加入流量限制（Rate Limit）
   - 設定檔案上傳大小限制

3. **輸入驗證**
   - 使用 Pydantic V2 進行資料驗證
   - 檔案類型與大小檢查
   - SQL 參數化查詢

### 第二階段：程式碼結構調整
1. **前端分層**
   - 拆分 App.jsx 為多個元件
   - 引入 React Query 進行狀態管理
   - 建立共用 Hooks
   - 建立 UI 元件庫

2. **後端分層**
   - 拆分 main.py 為獨立路由模組
   - 建立統一的錯誤處理
   - 加入中介層
   - 依功能注入依賴

### 第三階段：測試與品質
1. **測試補強**
   - 前端：React Testing Library
   - 後端：pytest + coverage
   - E2E：Playwright

2. **格式化與品質工具**
   - 前端：ESLint + Prettier + Husky
   - 後端：Ruff + mypy + pre-commit

### 第四階段：效能優化
1. **前端效能**
   - React.memo 降低不必要 re-render
   - 使用 Suspense 與 lazy loading
   - 資料虛擬化處理

2. **後端效能**
   - 加入 Redis 快取
   - 最佳化資料庫索引
   - 分批翻譯與重試策略

---

## 里程碑規劃

### 階段一：安全性修正（1-2 週）
| 任務 | 負責 | 估計時間 |
|------|------|----------|
| 移除 localStorage API Key | 前端 | 2 天 |
| CORS 設定調整 | 後端 | 1 天 |
| 加入流量限制 | 後端 | 3 天 |
| 檔案上傳大小限制 | 後端 | 1 天 |
| SQL 參數化查詢 | 後端 | 2 天 |

### 階段二：程式碼重構（2-4 週）
| 任務 | 負責 | 估計時間 |
|------|------|----------|
| 拆分前端元件 | 前端 | 1 週 |
| 建立 Hooks 抽象 | 前端 | 3 天 |
| 拆分後端路由 | 後端 | 1 週 |
| 統一錯誤處理 | 後端 | 3 天 |
| 依賴注入 | 後端 | 1 週 |

### 階段三：測試與 CI/CD（1-2 週）
| 任務 | 負責 | 估計時間 |
|------|------|----------|
| 新增後端單元測試 | 測試 | 5 天 |
| 新增前端單元測試 | 測試 | 5 天 |
| 配置 GitHub Actions | DevOps | 2 天 |
| 新增 E2E 測試 | 測試 | 3 天 |

### 階段四：效能優化（1-2 週）
| 任務 | 負責 | 估計時間 |
|------|------|----------|
| React 效能優化 | 前端 | 3 天 |
| 加入 Redis 快取 | 後端 | 5 天 |
| 資料庫最佳化 | 後端 | 3 天 |
| API 快取策略 | 後端 | 2 天 |

---

## 可立即執行項目

### 1. 建立 `.env.example`
```bash
OPENAI_API_KEY=
GEMINI_API_KEY=
TRANSLATE_LLM_MODE=mock
LLM_MAX_RETRIES=2
UPLOAD_MAX_SIZE=10485760
RATE_LIMIT_PER_MINUTE=60
```

### 2. 新增 `.eslintrc.cjs`
```javascript
module.exports = {
  root: true,
  env: { browser: true, es2020: true },
  extends: [
    'eslint:recommended',
    'plugin:react/recommended',
    'plugin:react/jsx-runtime'
  ],
  rules: {
    'react/react-in-jsx-scope': 'off',
    'react/prop-types': 'off'
  }
}
```

### 3. 新增 `.pre-commit-config.yaml`
```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files

  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black

  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
```

### 4. 新增 `pytest.ini`
```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --cov=backend --cov-report=html
```

### 5. 新增 `.gitignore`
```
# 環境檔案
.env
.env.local

# 測試覆蓋
.coverage
htmlcov/

# 快取
__pycache__/
*.pyc
.pytest_cache/
node_modules/

# 建置輸出
dist/
build/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
```

---

## 風險評估

| 風險 | 可能性 | 影響 | 緩解措施 |
|------|--------|------|----------|
| 重構導致功能回歸 | 中 | 高 | 增加測試覆蓋、分步驟釋出 |
| 安全性修正影響使用流程 | 低 | 中 | 先在內部環境試行 |
| 效能優化成本過高 | 中 | 中 | 先設定監控指標再調整 |

---

本報告彙整目前問題與改善方向，建議依里程碑逐步執行，並於每個階段完成後回顧成效與風險。
